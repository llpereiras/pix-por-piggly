<style>.wpgly-wrapper{max-width:720px;display:table;padding:12px}.wpgly-wrapper a{color:#4e4eef}.wpgly-spacing{display:block;padding:12px 0}.wpgly-button{display:inline-block;margin-right:12px;font-size:12px;text-transform:uppercase;padding:12px 24px;border:none;font-weight:700;cursor:pointer;background-color:#000;color:#fff!important;-webkit-border-radius:8px;-moz-border-radius:8px;-o-border-radius:8px;border-radius:8px;-webkit-transition:background-color .5s,color .5s;-moz-transition:background-color .5s,color .5s;-o-transition:background-color .5s,color .5s;transition:background-color .5s,color .5s;text-decoration:none}.wpgly-button:last-child{margin-right:0}.wpgly-button.wpgly-button-extended{width:100%;padding:12px 8px;margin-right:0;display:block}.wpgly-success{background:#1fd64f;color:#272727!important}.wpgly-neutral{background:#e7e7f5;color:#91959e!important}.wpgly-action{background:#4e4eef;color:#fff!important}.wpgly-accent{background:#ff188d;color:#fff!important}.wpgly-warning{background-color:#ff5e21;color:#fff!important}.wpgly-error{background:#e81d1d;color:#fff!important}.wpgly-button:hover{background-color:#3a6eff;color:#fff!important}.wpgly-caption{display:block;font-size:12px;color:#000}.wpgly-data{display:block;font-size:14px}.wpgly-title{margin:20px 0;position:relative;color:#000;font-size:16px}.wpgly-title::before{content:'';background-color:#000;height:2px;width:18px;position:absolute;bottom:-6px}h1.wpgly-title{font-size:24px}h2.wpgly-title{font-size:20px}h3.wpgly-title{font-size:18px}h5.wpgly-title{font-size:14px}ul.wpgly-tabs{display:table;padding:12px 0;width:100%;list-style:none;margin:0}ul.wpgly-tabs li{display:inline-table;margin:0;padding:0;white-space:nowrap}ul.wpgly-tabs li a{display:inline-table;margin:0;padding:0;white-space:nowrap;padding:12px;text-decoration:none;color:#3a6eff;position:relative;-webkit-transition:color .5s;-moz-transition:color .5s;-o-transition:color .5s;transition:color .5s}ul.wpgly-tabs li a::before{content:'';width:24px;height:2px;position:absolute;bottom:0;left:50%;margin-left:-12px;-webkit-transition:background-color .5s;-moz-transition:background-color .5s;-o-transition:background-color .5s;transition:background-color .5s}ul.wpgly-tabs li a:hover{color:#ff188d}ul.wpgly-tabs li a:hover::before{background-color:#ff188d}ul.wpgly-tabs li a::after{content:'';width:2px;height:12px;position:absolute;background-color:#b8bfcc;right:0;top:50%;margin-top:-4px;border-radius:4px}ul.wpgly-tabs li:last-child a::after{content:unset}ul.wpgly-tabs li a.current{color:#000;font-weight:700}ul.wpgly-tabs li a.current::before{background-color:#3a6eff}.wpgly-field{padding:6px 0;margin-bottom:12px}.wpgly-field:last-child{margin-bottom:0}.wpgly-label{font-size:14px;font-weight:700;margin-bottom:4px;display:block}.wpgly-checkbox{font-weight:400}.select2-container--default .select2-search--dropdown .select2-search__field,.wpgly-field input,.wpgly-field select,.wpgly-field textarea{width:100%;max-width:100%;padding:8px 12px;border:1px solid;border-color:#e0e0e0;-webkit-border-radius:6px;-moz-border-radius:6px;-o-border-radius:6px;border-radius:6px;-webkit-box-shadow:4px 4px 16px rgba(0,0,0,.1);-moz-box-shadow:4px 4px 16px rgba(0,0,0,.1);-o-box-shadow:4px 4px 16px rgba(0,0,0,.1);box-shadow:4px 4px 16px rgba(0,0,0,.1);-webkit-transition:border-color .5s,box-shadow .5s;-moz-transition:border-color .5s,box-shadow .5s;-o-transition:border-color .5s,box-shadow .5s;transition:border-color .5s,box-shadow .5s}.wpgly-input{line-height:0}.wpgly-field .select2-container .select2-selection{height:46px;border:1px solid;border-color:#e0e0e0;-webkit-border-radius:6px;-moz-border-radius:6px;-o-border-radius:6px;border-radius:6px;-webkit-box-shadow:4px 4px 16px rgba(0,0,0,.1);-moz-box-shadow:4px 4px 16px rgba(0,0,0,.1);-o-box-shadow:4px 4px 16px rgba(0,0,0,.1);box-shadow:4px 4px 16px rgba(0,0,0,.1);-webkit-transition:border-color .5s,box-shadow .5s;-moz-transition:border-color .5s,box-shadow .5s;-o-transition:border-color .5s,box-shadow .5s;transition:border-color .5s,box-shadow .5s}.wpgly-field .select2-container.select2-container--focus .select2-selection--single,.wpgly-field .select2-container.select2-container--open .select2-selection--multiple,.wpgly-field .select2-container.select2-container--open .select2-selection--single{-webkit-border-radius:6px!important;-moz-border-radius:6px!important;-o-border-radius:6px!important;border-radius:6px!important;border:1px solid;border-color:#e0e0e0;-webkit-box-box-shadow:4px 4px 16px rgba(255,24,141,.1);-moz-box-box-shadow:4px 4px 16px rgba(255,24,141,.1);-o-box-shadow:4px 4px 16px rgba(255,24,141,.1);box-shadow:4px 4px 16px rgba(255,24,141,.1)}.wpgly-field .select2-container .select2-selection--single .select2-selection__rendered{padding:8px 12px;font-size:14px}.wpgly-field .select2-container .select2-selection--single .select2-selection__rendered:hover{color:#ff188d}.wpgly-field .select2-container .select2-selection--single .select2-selection__arrow{height:100%}.select2-container--open .select2-dropdown{border:1px solid;border-color:#e0e0e0;-webkit-box-box-shadow:4px 4px 16px rgba(255,24,141,.1);-moz-box-box-shadow:4px 4px 16px rgba(255,24,141,.1);-o-box-shadow:4px 4px 16px rgba(255,24,141,.1);box-shadow:4px 4px 16px rgba(255,24,141,.1);overflow:hidden;border-radius:8px}.select2-container--open .select2-dropdown.select2-dropdown--below{margin-top:8px}.select2-container--open .select2-dropdown.select2-dropdown--above{margin-top:-8px}.select2-results .select2-results__group,.select2-results .select2-results__option{padding:8px 12px;font-size:14px}.select2-container--default .select2-results__option--highlighted[aria-selected],.select2-container--default .select2-results__option--highlighted[data-selected]{background-color:#ff188d;color:#fff}.select2-container--default .select2-results__option[data-selected=true]{background-color:#e3ecf9;color:#000}.wpgly-field input:focus{border-color:#ff188d;-webkit-box-box-shadow:4px 4px 16px rgba(255,24,141,.1);-moz-box-box-shadow:4px 4px 16px rgba(255,24,141,.1);-o-box-shadow:4px 4px 16px rgba(255,24,141,.1);box-shadow:4px 4px 16px rgba(255,24,141,.1);outline:2px solid transparent}.wpgly-field input[type=checkbox],.wpgly-field input[type=radio]{width:20px;height:20px}.wpgly-field input[type=checkbox]::before{content:'';border-radius:4px;width:10px;height:10px;margin:4px 4px 0;background-color:#ff188d}.wpgly-field input[type=radio]::before{content:'';border-radius:50%;width:10px;height:10px;margin:4px 4px 0;background-color:#ff188d}.wpgly-notice-box{display:table;width:100%;padding:16px;background-color:#fff;color:#000;-webkit-border-radius:12px;-moz-border-radius:12px;-o-border-radius:12px;border-radius:12px;-webkit-box-shadow:4px 4px 16px rgba(0,0,0,.1);-moz-box-shadow:4px 4px 16px rgba(0,0,0,.1);-o-box-shadow:4px 4px 16px rgba(0,0,0,.1);box-shadow:4px 4px 16px rgba(0,0,0,.1);margin-bottom:12px;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-o-box-sizing:border-box;box-sizing:border-box}.wpgly-notice-box a{font-weight:700}.wpgly-notice-box p{margin:1em 0}.wpgly-notice-box .wpgly-title{margin:0 0 20px}.wpgly-notice-box p:last-child{margin:1em 0 0}.wpgly-notice-box.wpgly-success a{color:#000}.wpgly-notice-box.wpgly-accent a,.wpgly-notice-box.wpgly-action a,.wpgly-notice-box.wpgly-error a,.wpgly-notice-box.wpgly-warning a{color:#fff}.wpgly-notice-box.wpgly-accent .wpgly-title,.wpgly-notice-box.wpgly-action .wpgly-title,.wpgly-notice-box.wpgly-error .wpgly-title,.wpgly-notice-box.wpgly-warning .wpgly-title{color:#fff}.wpgly-notice-box.wpgly-accent .wpgly-title::before,.wpgly-notice-box.wpgly-action .wpgly-title::before,.wpgly-notice-box.wpgly-error .wpgly-title::before,.wpgly-notice-box.wpgly-warning .wpgly-title::before{background-color:#fff}.wpgly-notice-box.wpgly-neutral{background:#e7e7f5}.wpgly-notice-box.wpgly-success{background:#1fd64f;color:#272727}.wpgly-notice-box.wpgly-action{background:#4e4eef;color:#fff}.wpgly-notice-box.wpgly-accent{background:#ff188d;color:#fff}.wpgly-notice-box.wpgly-warning{background-color:#ff5e21;color:#fff}.wpgly-notice-box.wpgly-error{background:#e81d1d;color:#fff}.wpgly-submit{display:block!important;padding:0!important;margin:0!important}.wpgly-ul{list-style:disc;padding:0 24px}</style>
<?php

use Piggly\WC\Pix\Order\ReceiptTable;

if ( ! defined( 'ABSPATH' ) ) { exit; }

if( !class_exists('WP_List_Table') ) require_once( ABSPATH . 'wp-admin/includes/class-wp-list-table.php' );

$table = new ReceiptTable();
$table->prepare_items();
?>

<div class="wpgly-notice-box wpgly-action">
	<h4 class="wpgly-title">Aviso</h4>
	<p>
		Os comprovantes enviados a partir do formulário com o shortcode
		<code>[pix-por-piggly-form]</code> irão aparecer aqui. Saiba mais
		em <strong><a href="<?=esc_url( admin_url( 'admin.php?page=wc-settings&tab=checkout&section=wc_piggly_pix_gateway' ) ).'&screen=shortcode'?>">Shortcodes</a>.</strong>
	</p>
</div>

<div class="wrap">
	<div id="icon-users" class="icon32"></div>
	<h2 class="wpgly-title">Comprovantes Pix</h2>
	<?php
	$saved = false;

	if ( $_SERVER['REQUEST_METHOD'] === 'POST' )
	{
		global $wpdb;
		$table_name = $wpdb->prefix.'wpgly_pix_receipts';

		try
		{
			// Nonce
			if ( !wp_verify_nonce( filter_input( INPUT_POST, '_wpnonce', FILTER_SANITIZE_STRING ), 'bulk-wpgly_pix_table_links' ) )
			{ throw new Exception(__('Erro ao realizar a verificação de segurança.', WC_PIGGLY_PIX_PLUGIN_NAME) ); }

			// HTTP Referer
			if ( wp_unslash( $_SERVER['REQUEST_URI'] ) !== filter_input( INPUT_POST, '_wp_http_referer', FILTER_SANITIZE_STRING ) )
			{ throw new Exception(__('A referência HTTP é incompatível com a esperada.', WC_PIGGLY_PIX_PLUGIN_NAME) ); }
		
			$action = filter_input( INPUT_POST, 'action', FILTER_SANITIZE_STRING );

			if ( $action === 'delete' )
			{
				$items = filter_input( INPUT_POST, 'items', FILTER_SANITIZE_STRING, FILTER_REQUIRE_ARRAY );

				foreach ( $items as $item )
				{ $this->delete_receipt((int)$item); }

				$saved = true;
			}
		}
		catch ( Exception $e )
		{ $saved = $e->getMessage(); }
	}
	else if ( $_SERVER['REQUEST_METHOD'] === 'GET' )
	{
		try
		{
			$action = filter_input( INPUT_GET, 'action', FILTER_SANITIZE_STRING );

			if ( $action === 'delete' )
			{
				$item = filter_input( INPUT_GET, 'item_id', FILTER_SANITIZE_STRING );

				if ( !empty($item) )
				{ 
					$this->delete_receipt((int)$item);
					$saved = true;
				}
			}
		}
		catch ( Exception $e )
		{ $saved = $e->getMessage(); }
	}
	?>

	<?php if ( $saved === true ) : ?>
	<p class="wpgly-notice-box wpgly-success">
	Ações realizadas com sucesso.
	</p>
	<?php elseif ( $saved !== false ) : ?>
	<p class="wpgly-notice-box wpgly-error">
		<strong>Não foi possível realizar as ações:</strong> <?=$saved;?>
	</p>
	<?php endif; ?>

	<form method="POST">
	<?php
		$table->prepare_items();
		$table->display();
	?>
	</form>
</div>